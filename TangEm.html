<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trai Tim 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle, #1a0005 0%, #000 100%); }
        #center-name {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Dancing Script', cursive; font-size: 65px;
            color: #fff; text-shadow: 0 0 20px #ff2d55, 0 0 40px #ff2d55;
            z-index: 10; pointer-events: none; opacity: 0.9;
        }
        #video-container {
            position: absolute; bottom: 20px; right: 20px; width: 180px; height: 135px;
            border-radius: 15px; border: 2px solid rgba(255, 45, 85, 0.5); 
            overflow: hidden; transform: scaleX(-1);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="center-name">Hưng tặng bạn gái</div>
<div id="video-container"><video id="input-video" playsinline></video></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // TẠO TEXTURE HẠT SÁNG (GLOW)
    const canvas = document.createElement('canvas');
    canvas.width = 32; canvas.height = 32;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
    grad.addColorStop(0, 'rgba(255,255,255,1)');
    grad.addColorStop(0.2, 'rgba(255,45,85,0.8)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad; ctx.fillRect(0, 0, 32, 32);
    const particleTexture = new THREE.CanvasTexture(canvas);

    // HÀM TOÁN HỌC TRÁI TIM ĐỀU ĐẶN
    function createHeart(count, scale, color, size, opacity) {
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(count * 3);
        const base = new Float32Array(count * 3);
        for (let i = 0; i < count; i++) {
            const t = Math.random() * Math.PI * 2;
            const r = scale * (Math.random() * 0.1 + 0.9); // Độ dày viền
            const x = 16 * Math.pow(Math.sin(t), 3) * r;
            const y = (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * r;
            const z = (Math.random() - 0.5) * 10 * Math.sin(t);
            pos[i*3] = x; pos[i*3+1] = y; pos[i*3+2] = z;
            base[i*3] = x; base[i*3+1] = y; base[i*3+2] = z;
        }
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({
            size: size, map: particleTexture, transparent: true,
            blending: THREE.AdditiveBlending, depthWrite: false, opacity: opacity, color: color
        });
        return { mesh: new THREE.Points(geo, mat), base: base };
    }

    // TẠO 2 LỚP TRÁI TIM NHƯ TRONG ẢNH
    const outerHeart = createHeart(15000, 0.35, 0xff1a4d, 0.12, 0.6); // Lớp bụi mờ bên ngoài
    const innerHeart = createHeart(8000, 0.15, 0xffffff, 0.08, 1.0);  // Lõi sáng bên trong
    scene.add(outerHeart.mesh);
    scene.add(innerHeart.mesh);
    camera.position.z = 15;

    // TƯƠNG TÁC TAY
    let expansion = 1;
    const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1 });
    hands.onResults(res => {
        if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
            let d = 0;
            res.multiHandLandmarks.forEach(hl => d += Math.hypot(hl[4].x - hl[8].x, hl[4].y - hl[8].y));
            expansion = THREE.MathUtils.lerp(expansion, 1 + (d / res.multiHandLandmarks.length) * 12, 0.15);
        }
    });
    const video = document.getElementById('input-video');
    new Camera(video, { onFrame: async () => await hands.send({image: video}) }).start();

    // ANIMATION
    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.002;
        const beat = 1 + Math.sin(time * 4) * 0.05;

        // Xử lý lớp ngoài bay bổng
        const p = outerHeart.mesh.geometry.attributes.position;
        for (let i = 0; i < p.count; i++) {
            const i3 = i * 3;
            const noise = Math.sin(time + i) * 0.1;
            p.array[i3] = outerHeart.base[i3] * expansion * beat + noise;
            p.array[i3+1] = outerHeart.base[i3+1] * expansion * beat + noise;
            p.array[i3+2] = outerHeart.base[i3+2] * expansion * beat + noise;
        }
        p.needsUpdate = true;

        // Xử lý lõi trong đập mạnh
        innerHeart.mesh.scale.set(beat, beat, beat);
        innerHeart.mesh.rotation.y += 0.01;
        outerHeart.mesh.rotation.y += 0.005;

        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>